<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Payment — Olivia Delish</title>
<style>
:root {
  --orange: #FFA500;
  --yellow: #FFD700;
  --navy: #0b1d3a;
  --white: #fff;
  --light-gray: #ddd;
}

body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background-color: var(--navy);
  color: var(--white);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}

h1 { color: var(--orange); margin-bottom: 20px; }
.logo { width: 120px; margin-bottom: 20px; }

.cart-container {
  background: rgba(255,255,255,0.05);
  padding: 20px;
  border-radius: 15px;
  width: 100%;
  max-width: 600px;
  margin-bottom: 20px;
}

ul { list-style: none; padding: 0; }
li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
.total { font-weight: bold; margin-top: 10px; color: var(--yellow); }

label { display: block; margin: 15px 0 5px; }
input[type="email"], input[type="text"] {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: none;
  outline: none;
}

.buttons { display: flex; justify-content: space-between; margin-top: 20px; }
button {
  padding: 10px 20px;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  font-weight: bold;
  transition: 0.3s;
}
#cancel-btn { background-color: #FF4C4C; color: var(--white); }
#cancel-btn:hover { background-color: #ff0000; }
#checkout-btn { background-color: var(--orange); color: var(--navy); }
#checkout-btn:hover { background-color: var(--yellow); }

.message {
  margin-top: 20px;
  padding: 15px;
  background: rgba(255,255,255,0.1);
  border-radius: 15px;
  display: none;
}

@media(max-width: 500px) {
  .buttons { flex-direction: column; gap: 10px; }
}
</style>
</head>
<body>

<img src="images/logo.png" alt="Olivia Delish Logo" class="logo">
<h1>Checkout</h1>

<div class="cart-container">
  <h2>Your Cart</h2>
  <ul id="cart-items"></ul>
  <div class="total" id="total">Total: GH₵0.00</div>
</div>

<label for="email">Your Email:</label>
<input type="email" id="email" placeholder="Enter your email" required>

<label for="phone">Phone Number:</label>
<input type="text" id="phone" placeholder="Enter your phone" required>

<label for="address">Delivery Address:</label>
<input type="text" id="address" placeholder="Enter delivery address" required>

<div class="buttons">
  <button id="cancel-btn">Cancel Order</button>
  <button id="checkout-btn">Proceed to Payment</button>
</div>

<div class="message" id="success-message">
  Thank you! Your order has been placed successfully.
</div>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
<script src="https://js.paystack.co/v1/inline.js"></script>
<script>
emailjs.init("BGuzMH9ebV7rUnrhx"); // EmailJS public key

let cart = JSON.parse(localStorage.getItem("cartItems")) || [];
let total = parseFloat(localStorage.getItem("cartTotal")) || 0;

const cartList = document.getElementById("cart-items");
const totalDisplay = document.getElementById("total");
const checkoutBtn = document.getElementById("checkout-btn");
const cancelBtn = document.getElementById("cancel-btn");
const successMessage = document.getElementById("success-message");

function displayCart() {
  cartList.innerHTML = "";
  cart.forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.count} x ${item.name} - GH₵${item.totalPrice.toFixed(2)}`;
    cartList.appendChild(li);
  });
  totalDisplay.textContent = `Total: GH₵${total.toFixed(2)}`;
}

displayCart();

cancelBtn.addEventListener("click", () => {
  if(confirm("Are you sure you want to cancel your order?")) {
    localStorage.removeItem("cartItems");
    localStorage.removeItem("cartTotal");
    cart = [];
    total = 0;
    displayCart();
    alert("Order cancelled!");
  }
});

checkoutBtn.addEventListener("click", () => {
  const email = document.getElementById("email").value;
  const phone = document.getElementById("phone").value;
  const address = document.getElementById("address").value;

  if(!email || !phone || !address){
    alert("Please fill all fields!");
    return;
  }

  const orderDetails = cart.map(i => `${i.count} x ${i.name}`).join(", ");
  const templateParams = {
    to_email: email,
    order_details: orderDetails,
    total: `GH₵${total.toFixed(2)}`,
    phone: phone,
    address: address
  };

  // Send EmailJS confirmation
  emailjs.send("service_g3378j3", "template_c2ge7fc", templateParams)
    .then(response => console.log('Email sent', response.status, response.text))
    .catch(error => console.error('Email failed', error));

  // Paystack Payment
  let handler = PaystackPop.setup({
    key: 'pk_live_6b1543665f3fd0ec08938ff844c42f571fc6d089',
    email: email,
    amount: total * 100,
    currency: "GHS",
    ref: '' + Math.floor(Math.random() * 1000000000 + 1),
    callback: function(response){
      successMessage.style.display = "block";
      localStorage.removeItem("cartItems");
      localStorage.removeItem("cartTotal");
      // Redirect to success page with reference
      window.location.href = `payment-success.html?reference=${response.reference}`;
    },
    onClose: function(){
      alert('Transaction was not completed, window closed.');
    }
  });
  handler.openIframe();
});
</script>
</body>
</html>